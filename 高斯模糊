import http.server
import socketserver
import os
import json
import urllib.parse
import threading
import webbrowser
from datetime import datetime

# é…ç½®ç«¯å£
PORT = 8000

# ç”Ÿæˆçš„ HTML ç•Œé¢ä»£ç  (åŒ…å«ä¸Šä¼ å’Œä¸‹è½½åŠŸèƒ½)
HTML_CONTENT = """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi æ–‡ä»¶äº’ä¼ </title>
    <style>
        :root { --primary: #007bff; --bg: #f4f4f9; --card: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 600px; width: 100%; background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-top: 0; }
        .status { text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9rem; }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-area { border: 2px dashed #ccc; padding: 30px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.3s; position: relative; }
        .upload-area:hover { border-color: var(--primary); background: #f0f7ff; }
        .upload-area input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .btn { display: block; width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; margin-top: 15px; }
        .btn:disabled { background: #ccc; }
        
        /* æ–‡ä»¶åˆ—è¡¨ */
        .file-list { margin-top: 25px; border-top: 1px solid #eee; padding-top: 15px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f9f9f9; }
        .file-info { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 70%; }
        .download-link { color: var(--primary); text-decoration: none; font-weight: bold; }
        .delete-btn { color: #dc3545; background: none; border: none; cursor: pointer; font-size: 0.8rem; margin-left: 10px; }
        
        #log { margin-top: 20px; font-size: 0.8rem; color: #888; max-height: 100px; overflow-y: auto; background: #eee; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ WiFi æ–‡ä»¶äº’ä¼ </h1>
        <div class="status" id="status">å·²è¿æ¥åˆ°æœ¬åœ°æœåŠ¡</div>

        <!-- ä¸Šä¼ éƒ¨åˆ† -->
        <div class="upload-area">
            <input type="file" id="fileInput" multiple>
            <p><strong>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</strong> æˆ–æ‹–æ‹½åˆ°è¿™é‡Œ</p>
            <p style="font-size: 0.8rem; color: #888;">æ”¯æŒå›¾ç‰‡ã€æ–‡æ¡£ã€è§†é¢‘ç­‰æ‰€æœ‰æ ¼å¼</p>
        </div>
        <button class="btn" id="uploadBtn" disabled>å¼€å§‹ä¸Šä¼ åˆ°ç”µè„‘</button>

        <!-- ç”µè„‘ä¸Šçš„æ–‡ä»¶åˆ—è¡¨ (ä¸‹è½½éƒ¨åˆ†) -->
        <div class="file-list">
            <h3>ğŸ’» ç”µè„‘ä¸Šçš„æ–‡ä»¶ (ç‚¹å‡»ä¸‹è½½)</h3>
            <div id="fileListContainer">åŠ è½½ä¸­...</div>
        </div>

        <div id="log"></div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const logDiv = document.getElementById('log');
        const fileListContainer = document.getElementById('fileListContainer');

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                uploadBtn.disabled = false;
                uploadBtn.innerText = `ä¸Šä¼  ${fileInput.files.length} ä¸ªæ–‡ä»¶åˆ°ç”µè„‘`;
            } else {
                uploadBtn.disabled = true;
                uploadBtn.innerText = 'å¼€å§‹ä¸Šä¼ åˆ°ç”µè„‘';
            }
        });

        // ä¸Šä¼ é€»è¾‘
        uploadBtn.addEventListener('click', async () => {
            if (!fileInput.files.length) return;
            
            uploadBtn.disabled = true;
            uploadBtn.innerText = 'ä¸Šä¼ ä¸­...';
            
            for (let i = 0; i < fileInput.files.length; i++) {
                const file = fileInput.files[i];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    log(`æ­£åœ¨ä¸Šä¼ : ${file.name}...`);
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        log(`âœ… æˆåŠŸ: ${file.name}`);
                    } else {
                        const err = await response.text();
                        log(`âŒ å¤±è´¥: ${file.name} - ${err}`);
                    }
                } catch (e) {
                    log(`âŒ é”™è¯¯: ${file.name} - ${e.message}`);
                }
            }
            
            uploadBtn.innerText = 'ä¸Šä¼ å®Œæˆ';
            setTimeout(() => {
                uploadBtn.disabled = false;
                uploadBtn.innerText = 'ç»§ç»­ä¸Šä¼ ';
                fileInput.value = ''; // é‡ç½®
                loadFileList(); // åˆ·æ–°åˆ—è¡¨
            }, 2000);
        });

        // è·å–æ–‡ä»¶åˆ—è¡¨
        async function loadFileList() {
            try {
                const res = await fetch('/list');
                const files = await res.json();
                fileListContainer.innerHTML = '';
                
                if (files.length === 0) {
                    fileListContainer.innerHTML = '<p style="color:#999; text-align:center;">æš‚æ— æ–‡ä»¶</p>';
                    return;
                }

                files.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.innerHTML = `
                        <span class="file-info">${file.name} <small style="color:#999">(${formatSize(file.size)})</small></span>
                        <div>
                            <a href="/download/${encodeURIComponent(file.name)}" class="download-link" download>ä¸‹è½½</a>
                            <button class="delete-btn" onclick="deleteFile('${encodeURIComponent(file.name)}')">åˆ é™¤</button>
                        </div>
                    `;
                    fileListContainer.appendChild(div);
                });
            } catch (e) {
                fileListContainer.innerHTML = '<p style="color:red">åŠ è½½å¤±è´¥</p>';
            }
        }

        // åˆ é™¤æ–‡ä»¶
        async function deleteFile(encodedName) {
            if(!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) return;
            try {
                await fetch(`/delete/${encodedName}`, { method: 'DELETE' });
                loadFileList();
                log('æ–‡ä»¶å·²åˆ é™¤');
            } catch(e) {
                log('åˆ é™¤å¤±è´¥');
            }
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // åˆå§‹åŒ–åŠ è½½
        loadFileList();
        setInterval(loadFileList, 5000); // æ¯5ç§’è‡ªåŠ¨åˆ·æ–°
    </script>
</body>
</html>
"""

class Handler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/':
            self.send_response(200)
            self.send_header('Content-type', 'text/html; charset=utf-8')
            self.end_headers()
            self.wfile.write(HTML_CONTENT.encode('utf-8'))
        elif self.path.startswith('/list'):
            self.send_response(200)
            self.send_header('Content-type', 'application/json; charset=utf-8')
            self.end_headers()
            files = []
            for f in os.listdir('.'):
                if os.path.isfile(f) and f != __file__ and not f.startswith('.'):
                    files.append({'name': f, 'size': os.path.getsize(f)})
            self.wfile.write(json.dumps(files).encode('utf-8'))
        elif self.path.startswith('/download/'):
            filename = urllib.parse.unquote(self.path[10:])
            if os.path.exists(filename):
                self.send_response(200)
                self.send_header('Content-Disposition', f'attachment; filename="{filename}"')
                self.end_headers()
                with open(filename, 'rb') as f:
                    self.wfile.write(f.read())
            else:
                self.send_error(404, "File not found")
        else:
            super().do_GET()

    def do_POST(self):
        if self.path.startswith('/upload'):
            content_length = int(self.headers['Content-Length'])
            # ç®€å•çš„ multipart è§£æ (ä¸ºäº†å•æ–‡ä»¶ç®€æ´ï¼Œä¸ä½¿ç”¨é¢å¤–åº“ï¼Œä»…å¤„ç†å•æ–‡ä»¶ä¸Šä¼ )
            # æ³¨æ„ï¼šè¿™é‡Œä¸ºäº†ä»£ç æç®€ï¼Œä½¿ç”¨äº†ç¨å¾®ç²—ç³™çš„è§£ææ–¹å¼ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ç”¨ werkzeug
            post_data = self.rfile.read(content_length)
            
            # æŸ¥æ‰¾æ–‡ä»¶å
            boundary = self.headers['Content-Type'].split('boundary=')[1].encode()
            parts = post_data.split(b'--' + boundary)
            
            for part in parts:
                if b'filename=' in part:
                    header, data = part.split(b'\r\n\r\n', 1)
                    header_str = header.decode('utf-8', errors='ignore')
                    for line in header_str.split('\r\n'):
                        if 'filename=' in line:
                            filename = line.split('filename=')[1].strip().strip('"')
                            # æ¸…ç†å¯èƒ½çš„è·¯å¾„ä¿¡æ¯
                            filename = os.path.basename(filename)
                            
                            # ç§»é™¤æœ«å°¾çš„è¾¹ç•Œç¬¦å’Œæ¢è¡Œ
                            if data.endswith(b'\r\n'):
                                data = data[:-2]
                            elif data.endswith(b'--\r\n'):
                                data = data[:-4]
                            elif data.endswith(b'--'):
                                data = data[:-2]
                                
                            with open(filename, 'wb') as f:
                                f.write(data)
                            print(f"Received: {filename}")
                            
                            self.send_response(200)
                            self.send_header('Content-type', 'text/plain')
                            self.end_headers()
                            self.wfile.write(b'OK')
                            return
            
            self.send_error(400, "No file found")
        else:
            self.send_error(404)

    def do_DELETE(self):
        if self.path.startswith('/delete/'):
            filename = urllib.parse.unquote(self.path[8:])
            if os.path.exists(filename):
                os.remove(filename)
                self.send_response(200)
                self.end_headers()
            else:
                self.send_error(404)
        else:
            self.send_error(404)

def get_ip():
    import socket
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        s.connect(('8.8.8.8', 80))
        ip = s.getsockname()[0]
    except Exception:
        ip = '127.0.0.1'
    finally:
        s.close()
    return ip

if __name__ == '__main__':
    ip = get_ip()
    url = f"http://{ip}:{PORT}"
    
    print("="*40)
    print("ğŸš€ WiFi æ–‡ä»¶äº’ä¼ æœåŠ¡å·²å¯åŠ¨!")
    print(f"ğŸ“± æ‰‹æœºè¯·æ‰«æä¸‹æ–¹äºŒç»´ç ï¼Œæˆ–è®¿é—®: {url}")
    print("="*40)
    
    # å°è¯•ç”ŸæˆäºŒç»´ç  (éœ€è¦ qrcode åº“ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸æ˜¾ç¤º)
    try:
        import qrcode
        qr = qrcode.make(url)
        qr.show() # è¿™ä¼šå¼¹å‡ºä¸€ä¸ªçª—å£æ˜¾ç¤ºäºŒç»´ç 
    except ImportError:
        print("ğŸ’¡ æç¤º: å®‰è£… 'qrcode' åº“å¯è‡ªåŠ¨æ˜¾ç¤ºäºŒç»´ç  (pip install qrcode)")
        print(f"ğŸ‘‰ è¯·åœ¨æ‰‹æœºæµè§ˆå™¨è¾“å…¥: {url}")
    
    # è‡ªåŠ¨æ‰“å¼€ç”µè„‘æµè§ˆå™¨
    webbrowser.open(url)

    with socketserver.TCPServer(("", PORT), Handler) as httpd:
        try:
            httpd.serve_forever()
        except KeyboardInterrupt:
            print("\nğŸ›‘ æœåŠ¡å·²åœæ­¢")
